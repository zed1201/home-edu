<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç®¡ç† - å®¶åº­æ•™è‚²ä»»åŠ¡ç§¯åˆ†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">ğŸ¯ å®¶åº­æ•™è‚²ç³»ç»Ÿ</div>
            <div class="nav-links">
                <a href="/parent/dashboard.html">é¦–é¡µ</a>
                <a href="/parent/create-task.html">å‘å¸ƒä»»åŠ¡</a>
                <a href="/parent/task-list.html" class="active">ä»»åŠ¡ç®¡ç†</a>
                <a href="/parent/create-prize.html">å¥–å“ç®¡ç†</a>
            </div>
            <div class="user-info">
                <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>ğŸ“‹ æˆ‘çš„ä»»åŠ¡ç®¡ç†</h2>
                <a href="/parent/create-task.html" class="btn btn-primary">
                    â• å‘å¸ƒæ–°ä»»åŠ¡
                </a>
            </div>
            
            <!-- ç­›é€‰å’Œæœç´¢ -->
            <div class="filter-bar">
                <div class="filter-item">
                    <label for="statusFilter">çŠ¶æ€ç­›é€‰ï¼š</label>
                    <select id="statusFilter" onchange="filterTasks()">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="PUBLISHED">å·²å‘å¸ƒ</option>
                        <option value="IN_PROGRESS">è¿›è¡Œä¸­</option>
                        <option value="WAIT_CONFIRM">å¾…ç¡®è®¤</option>
                        <option value="DONE">å·²å®Œæˆ</option>
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="searchInput">æœç´¢ï¼š</label>
                    <input type="text" id="searchInput" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜..." 
                           onkeyup="searchTasks()">
                </div>
                
                <button class="btn btn-secondary btn-sm" onclick="loadTasks()">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- ä»»åŠ¡ç»Ÿè®¡ -->
        <div class="grid-4" style="margin-bottom: 2rem;">
            <div class="card stats-card">
                <div class="stats-number" id="totalTasksCount">-</div>
                <div class="stats-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="card stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);">
                <div class="stats-number" id="pendingTasksCount">-</div>
                <div class="stats-label">å¾…ç¡®è®¤</div>
            </div>
            <div class="card stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <div class="stats-number" id="completedTasksCount">-</div>
                <div class="stats-label">å·²å®Œæˆ</div>
            </div>
            <div class="card stats-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
                <div class="stats-number" id="inProgressTasksCount">-</div>
                <div class="stats-label">è¿›è¡Œä¸­</div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="card">
            <h3>ğŸ“ ä»»åŠ¡åˆ—è¡¨</h3>
            <div id="tasksList" class="task-list loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="taskDetailModal" class="modal" style="display: none;">
        <div class="modal-content card" style="max-width: 600px; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>ğŸ“‹ ä»»åŠ¡è¯¦æƒ…</h3>
                <button class="btn btn-secondary btn-sm" onclick="closeTaskDetail()">âœ•</button>
            </div>
            <div id="taskDetailContent">
                <!-- ä»»åŠ¡è¯¦æƒ…å†…å®¹å°†é€šè¿‡JSå¡«å…… -->
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        let allTasks = [];
        let filteredTasks = [];

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            if (!Page.requireAuth() || !Page.requireRole('PARENT')) {
                return;
            }

            loadTasks();
        });

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                Loading.show(document.getElementById('tasksList'));
                const response = await Http.get('/api/tasks/my-created');
                
                if (response.code === 200) {
                    allTasks = response.data || [];
                    filteredTasks = [...allTasks];
                    
                    updateStatistics();
                    renderTasks();
                } else {
                    throw new Error(response.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('tasksList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        <p>åŠ è½½ä»»åŠ¡å¤±è´¥</p>
                        <button class="btn btn-primary" onclick="loadTasks()">é‡è¯•</button>
                    </div>
                `;
                Toast.error('åŠ è½½ä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const stats = {
                total: allTasks.length,
                pending: allTasks.filter(task => task.status === 'WAIT_CONFIRM').length,
                completed: allTasks.filter(task => task.status === 'DONE').length,
                inProgress: allTasks.filter(task => task.status === 'IN_PROGRESS').length
            };

            document.getElementById('totalTasksCount').textContent = stats.total;
            document.getElementById('pendingTasksCount').textContent = stats.pending;
            document.getElementById('completedTasksCount').textContent = stats.completed;
            document.getElementById('inProgressTasksCount').textContent = stats.inProgress;
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const container = document.getElementById('tasksList');
            
            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <p>æš‚æ— ä»»åŠ¡</p>
                        <a href="/parent/create-task.html" class="btn btn-primary" style="margin-top: 1rem;">
                            â• å‘å¸ƒç¬¬ä¸€ä¸ªä»»åŠ¡
                        </a>
                    </div>
                `;
                return;
            }

            // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
            const sortedTasks = filteredTasks.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));

            container.innerHTML = sortedTasks.map(task => `
                <div class="task-item" style="margin-bottom: 1rem;">
                    <div class="task-header">
                        <div class="task-title">${task.title}</div>
                        <div class="task-status status-${task.status.toLowerCase().replace('_', '-')}">${getStatusText(task.status)}</div>
                    </div>
                    
                    <div class="task-description">${task.description || 'æš‚æ— æè¿°'}</div>
                    
                    <div class="task-meta">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span class="task-deadline">æˆªæ­¢ï¼š${DateUtil.format(task.deadline)}</span>
                            <span class="task-points">${task.point} ç§¯åˆ†</span>
                            <span style="color: #666; font-size: 0.9rem;">åˆ›å»ºï¼š${DateUtil.format(task.createTime)}</span>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="viewTaskDetail(${task.id})">
                                ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            ${task.status === 'WAIT_CONFIRM' ? `
                                <button class="btn btn-success" onclick="confirmTask(${task.id}, true)">
                                    âœ… ç¡®è®¤å®Œæˆ
                                </button>
                                <button class="btn btn-danger" onclick="confirmTask(${task.id}, false)">
                                    âŒ é‡æ–°å®Œæˆ
                                </button>
                            ` : ''}
                            ${task.status === 'PUBLISHED' ? `
                                <button class="btn btn-warning" onclick="editTask(${task.id})">
                                    âœï¸ ç¼–è¾‘
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ç­›é€‰ä»»åŠ¡
        function filterTasks() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchKeyword = document.getElementById('searchInput').value.toLowerCase();

            filteredTasks = allTasks.filter(task => {
                const matchStatus = !statusFilter || task.status === statusFilter;
                const matchSearch = !searchKeyword || 
                    task.title.toLowerCase().includes(searchKeyword) ||
                    (task.description && task.description.toLowerCase().includes(searchKeyword));
                
                return matchStatus && matchSearch;
            });

            renderTasks();
        }

        // æœç´¢ä»»åŠ¡
        function searchTasks() {
            filterTasks();
        }

        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        async function viewTaskDetail(taskId) {
            try {
                // ä»æœ¬åœ°æ•°æ®ä¸­æ‰¾åˆ°ä»»åŠ¡
                const task = allTasks.find(t => t.id === taskId);
                if (!task) {
                    Toast.error('ä»»åŠ¡ä¸å­˜åœ¨');
                    return;
                }

                // è·å–ä»»åŠ¡åˆ†é…ä¿¡æ¯
                const assignmentResponse = await Http.get(`/api/tasks/${taskId}/assignments`);
                let assignments = [];
                if (assignmentResponse.code === 200) {
                    assignments = assignmentResponse.data || [];
                }

                const content = document.getElementById('taskDetailContent');
                content.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <h4>${task.title}</h4>
                        <div class="task-status status-${task.status.toLowerCase().replace('_', '-')}" style="display: inline-block;">
                            ${getStatusText(task.status)}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>ä»»åŠ¡æè¿°ï¼š</strong>
                        <p style="margin: 0.5rem 0; line-height: 1.6;">${task.description || 'æš‚æ— æè¿°'}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong>å¥–åŠ±ç§¯åˆ†ï¼š</strong>
                            <span class="task-points">${task.point} ç§¯åˆ†</span>
                        </div>
                        <div>
                            <strong>æˆªæ­¢æ—¶é—´ï¼š</strong>
                            <span>${DateUtil.format(task.deadline)}</span>
                        </div>
                        <div>
                            <strong>åˆ›å»ºæ—¶é—´ï¼š</strong>
                            <span>${DateUtil.format(task.createTime)}</span>
                        </div>
                        <div>
                            <strong>æ›´æ–°æ—¶é—´ï¼š</strong>
                            <span>${DateUtil.format(task.updateTime)}</span>
                        </div>
                    </div>
                    
                    ${assignments.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <strong>ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼š</strong>
                            <div style="margin-top: 0.5rem;">
                                ${assignments.map(assignment => `
                                    <div style="padding: 0.5rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;">
                                        <div>å­¦ç”Ÿï¼š${assignment.studentName}</div>
                                        <div>é¢†å–æ—¶é—´ï¼š${DateUtil.format(assignment.assignTime)}</div>
                                        ${assignment.submitTime ? `<div>æäº¤æ—¶é—´ï¼š${DateUtil.format(assignment.submitTime)}</div>` : ''}
                                        ${assignment.submitContent ? `<div>æäº¤å†…å®¹ï¼š${assignment.submitContent}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="color: #666; text-align: center; padding: 1rem;">
                            è¿˜æ²¡æœ‰å­¦ç”Ÿé¢†å–æ­¤ä»»åŠ¡
                        </div>
                    `}
                    
                    ${task.status === 'WAIT_CONFIRM' ? `
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="confirmTaskFromDetail(${task.id}, true)">
                                âœ… ç¡®è®¤å®Œæˆ
                            </button>
                            <button class="btn btn-danger" onclick="confirmTaskFromDetail(${task.id}, false)">
                                âŒ é‡æ–°å®Œæˆ
                            </button>
                        </div>
                    ` : ''}
                `;

                document.getElementById('taskDetailModal').style.display = 'block';
            } catch (error) {
                Toast.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥');
            }
        }

        // å…³é—­ä»»åŠ¡è¯¦æƒ…
        function closeTaskDetail() {
            document.getElementById('taskDetailModal').style.display = 'none';
        }

        // ç¡®è®¤ä»»åŠ¡ï¼ˆä»è¯¦æƒ…é¡µé¢ï¼‰
        async function confirmTaskFromDetail(taskId, isCompleted) {
            await confirmTask(taskId, isCompleted);
            closeTaskDetail();
        }

        // ç¡®è®¤ä»»åŠ¡
        async function confirmTask(taskId, isCompleted) {
            try {
                Loading.show();
                const response = await Http.put(`/api/tasks/${taskId}/confirm`, {
                    isCompleted: isCompleted,
                    finalPoint: null // ä½¿ç”¨åŸå§‹ç§¯åˆ†
                });

                if (response.code === 200) {
                    Toast.success(isCompleted ? 'ä»»åŠ¡ç¡®è®¤å®Œæˆï¼' : 'ä»»åŠ¡å·²è¦æ±‚é‡æ–°å®Œæˆ');
                    // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    await loadTasks();
                } else {
                    Toast.error(response.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // ç¼–è¾‘ä»»åŠ¡
        function editTask(taskId) {
            Toast.info('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
            // å¯ä»¥è·³è½¬åˆ°ç¼–è¾‘é¡µé¢æˆ–æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'PUBLISHED': 'å·²å‘å¸ƒ',
                'IN_PROGRESS': 'è¿›è¡Œä¸­',
                'WAIT_CONFIRM': 'å¾…ç¡®è®¤',
                'DONE': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('taskDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskDetail();
            }
        });
    </script>
</body>
</html> 