<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥–å“ç®¡ç† - å®¶åº­æ•™è‚²ä»»åŠ¡ç§¯åˆ†ç³»ç»Ÿ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¯</text></svg>">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">ğŸ¯ å®¶åº­æ•™è‚²ç³»ç»Ÿ</div>
            <div class="nav-links">
                <a href="/parent/dashboard.html">é¦–é¡µ</a>
                <a href="/parent/create-task.html">å‘å¸ƒä»»åŠ¡</a>
                <a href="/parent/task-list.html">ä»»åŠ¡ç®¡ç†</a>
                <a href="/parent/create-prize.html" class="active">å¥–å“ç®¡ç†</a>
            </div>
            <div class="user-info">
                <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- åˆ›å»ºå¥–å“è¡¨å• -->
        <div class="card">
            <h2>ğŸ åˆ›å»ºæ–°å¥–å“</h2>
            <p style="color: #666; margin-bottom: 2rem;">
                è®¾ç½®å¥–å“ä¿¡æ¯ï¼Œè®©å­©å­ç”¨ç§¯åˆ†å…‘æ¢å¿ƒä»ªçš„å¥–åŠ±ã€‚
            </p>

            <form id="createPrizeForm">
                <div class="form-group">
                    <label for="name">å¥–å“åç§° *</label>
                    <input type="text" id="name" name="name" required 
                           placeholder="ä¾‹å¦‚ï¼šç©å…·å°æ±½è½¦ã€çœ‹ç”µå½±ç¥¨ç­‰">
                </div>

                <div class="form-group">
                    <label for="description">å¥–å“æè¿°</label>
                    <textarea id="description" name="description" 
                              placeholder="è¯¦ç»†æè¿°å¥–å“ä¿¡æ¯..."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="costPoints">æ‰€éœ€ç§¯åˆ† *</label>
                        <input type="number" id="costPoints" name="costPoints" required min="1" max="1000" 
                               placeholder="1-1000" value="20">
                    </div>

                    <div class="form-group">
                        <label for="stock">åº“å­˜æ•°é‡ *</label>
                        <input type="number" id="stock" name="stock" required min="1" max="100" 
                               placeholder="1-100" value="1">
                    </div>

                    <div class="form-group">
                        <label for="expireDate">æœ‰æ•ˆæœŸ</label>
                        <input type="date" id="expireDate" name="expireDate">
                        <small style="color: #666;">ç•™ç©ºè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ</small>
                    </div>
                </div>

                <!-- å¥–å“æ¨¡æ¿ -->
                <div class="form-group">
                    <label>ğŸ å¸¸ç”¨å¥–å“æ¨¡æ¿</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="usePrizeTemplate('toy')">
                            ğŸš— ç©å…·
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="usePrizeTemplate('movie')">
                            ğŸ¬ çœ‹ç”µå½±
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="usePrizeTemplate('money')">
                            ğŸ’° é›¶èŠ±é’±
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="usePrizeTemplate('book')">
                            ğŸ“š å›¾ä¹¦
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="usePrizeTemplate('food')">
                            ğŸ° ç¾é£Ÿ
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="usePrizeTemplate('outing')">
                            ğŸª å‡ºæ¸¸
                        </button>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        âœ… åˆ›å»ºå¥–å“
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetPrizeForm()">
                        ğŸ”„ é‡ç½®è¡¨å•
                    </button>
                </div>
            </form>
        </div>

        <!-- å¥–å“åˆ—è¡¨ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>ğŸ æˆ‘çš„å¥–å“åˆ—è¡¨</h3>
                <button class="btn btn-secondary" onclick="loadPrizes()">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
            
            <div id="prizesList" class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- å…‘æ¢è®°å½• -->
        <div class="card">
            <h3>ğŸ“Š å…‘æ¢è®°å½•</h3>
            <div id="exchangesList" class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- å¥–å“ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editPrizeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">
            <div class="card" style="max-width: 500px; width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>âœï¸ ç¼–è¾‘å¥–å“</h3>
                    <button class="btn btn-secondary" onclick="closeEditModal()">âœ•</button>
                </div>
                
                <form id="editPrizeForm">
                    <div class="form-group">
                        <label for="editName">å¥–å“åç§° *</label>
                        <input type="text" id="editName" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="editDescription">å¥–å“æè¿°</label>
                        <textarea id="editDescription" name="description"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="editCostPoints">æ‰€éœ€ç§¯åˆ† *</label>
                            <input type="number" id="editCostPoints" name="costPoints" required min="1" max="1000">
                        </div>

                        <div class="form-group">
                            <label for="editStock">åº“å­˜æ•°é‡ *</label>
                            <input type="number" id="editStock" name="stock" required min="0" max="100">
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            âœ… ä¿å­˜ä¿®æ”¹
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        let currentEditPrizeId = null;

        // å¥–å“æ¨¡æ¿
        const prizeTemplates = {
            toy: {
                name: 'ç©å…·å°æ±½è½¦',
                description: 'ç²¾ç¾çš„é¥æ§å°æ±½è½¦ï¼ŒåŸ¹å…»åŠ¨æ‰‹èƒ½åŠ›',
                costPoints: 50,
                stock: 2
            },
            movie: {
                name: 'çœ‹ç”µå½±ç¥¨',
                description: 'å¯ä»¥çœ‹ä¸€åœºå–œæ¬¢çš„ç”µå½±',
                costPoints: 30,
                stock: 5
            },
            money: {
                name: 'é›¶èŠ±é’±10å…ƒ',
                description: 'é¢å¤–çš„é›¶èŠ±é’±å¥–åŠ±',
                costPoints: 20,
                stock: 10
            },
            book: {
                name: 'ç²¾ç¾å›¾ä¹¦',
                description: 'é€‰æ‹©ä¸€æœ¬å–œæ¬¢çš„å›¾ä¹¦',
                costPoints: 25,
                stock: 3
            },
            food: {
                name: 'ç¾é£Ÿå¤§é¤',
                description: 'äº«å—ä¸€é¡¿ç¾å‘³å¤§é¤',
                costPoints: 40,
                stock: 2
            },
            outing: {
                name: 'å‘¨æœ«å‡ºæ¸¸',
                description: 'å’Œå®¶äººä¸€èµ·å‡ºæ¸¸ä¸€å¤©',
                costPoints: 80,
                stock: 1
            }
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            if (!Page.requireAuth() || !Page.requireRole('PARENT')) {
                return;
            }

            initCreatePrizeForm();
            initEditPrizeForm();
            loadPrizes();
            loadExchanges();
        });

        // åˆå§‹åŒ–åˆ›å»ºå¥–å“è¡¨å•
        function initCreatePrizeForm() {
            const form = document.getElementById('createPrizeForm');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const prizeData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    costPoints: parseInt(formData.get('costPoints')),
                    stock: parseInt(formData.get('stock')),
                    expireDate: formData.get('expireDate') || null
                };

                // è¡¨å•éªŒè¯
                const validation = validatePrizeForm(prizeData);
                if (!validation.isValid) {
                    Toast.error(validation.message);
                    return;
                }

                try {
                    Loading.show();
                    const response = await Http.post('/api/prizes', prizeData);
                    
                    if (response.code === 200) {
                        Toast.success('å¥–å“åˆ›å»ºæˆåŠŸï¼');
                        form.reset();
                        document.getElementById('costPoints').value = 20;
                        document.getElementById('stock').value = 1;
                        loadPrizes();
                    } else {
                        Toast.error(response.message || 'åˆ›å»ºå¤±è´¥');
                    }
                } catch (error) {
                    Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                } finally {
                    Loading.hide();
                }
            });
        }

        // åˆå§‹åŒ–ç¼–è¾‘å¥–å“è¡¨å•
        function initEditPrizeForm() {
            const form = document.getElementById('editPrizeForm');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentEditPrizeId) return;

                const formData = new FormData(form);
                const prizeData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    costPoints: parseInt(formData.get('costPoints')),
                    stock: parseInt(formData.get('stock'))
                };

                try {
                    Loading.show();
                    const response = await Http.put(`/api/prizes/${currentEditPrizeId}`, prizeData);
                    
                    if (response.code === 200) {
                        Toast.success('å¥–å“æ›´æ–°æˆåŠŸï¼');
                        closeEditModal();
                        loadPrizes();
                    } else {
                        Toast.error(response.message || 'æ›´æ–°å¤±è´¥');
                    }
                } catch (error) {
                    Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                } finally {
                    Loading.hide();
                }
            });
        }

        // éªŒè¯å¥–å“è¡¨å•
        function validatePrizeForm(data) {
            if (!data.name || data.name.trim().length === 0) {
                return { isValid: false, message: 'è¯·å¡«å†™å¥–å“åç§°' };
            }

            if (data.name.length > 50) {
                return { isValid: false, message: 'å¥–å“åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦' };
            }

            if (data.description && data.description.length > 500) {
                return { isValid: false, message: 'å¥–å“æè¿°ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦' };
            }

            if (!data.costPoints || data.costPoints < 1 || data.costPoints > 1000) {
                return { isValid: false, message: 'ç§¯åˆ†å¿…é¡»åœ¨1-1000ä¹‹é—´' };
            }

            if (!data.stock || data.stock < 1 || data.stock > 100) {
                return { isValid: false, message: 'åº“å­˜å¿…é¡»åœ¨1-100ä¹‹é—´' };
            }

            if (data.expireDate) {
                const expire = new Date(data.expireDate);
                const now = new Date();
                if (expire <= now) {
                    return { isValid: false, message: 'æœ‰æ•ˆæœŸå¿…é¡»æ™šäºä»Šå¤©' };
                }
            }

            return { isValid: true };
        }

        // ä½¿ç”¨å¥–å“æ¨¡æ¿
        function usePrizeTemplate(templateName) {
            const template = prizeTemplates[templateName];
            if (!template) return;

            document.getElementById('name').value = template.name;
            document.getElementById('description').value = template.description;
            document.getElementById('costPoints').value = template.costPoints;
            document.getElementById('stock').value = template.stock;

            Toast.info(`å·²åº”ç”¨"${template.name}"æ¨¡æ¿`);
        }

        // é‡ç½®å¥–å“è¡¨å•
        function resetPrizeForm() {
            document.getElementById('createPrizeForm').reset();
            document.getElementById('costPoints').value = 20;
            document.getElementById('stock').value = 1;
            Toast.info('è¡¨å•å·²é‡ç½®');
        }

        // åŠ è½½å¥–å“åˆ—è¡¨
        async function loadPrizes() {
            try {
                const container = document.getElementById('prizesList');
                Loading.show(container);
                
                const response = await Http.get('/api/prizes/my-created');
                
                if (response.code === 200) {
                    const prizes = response.data || [];
                    
                    if (prizes.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                è¿˜æ²¡æœ‰åˆ›å»ºå¥–å“ï¼Œè¯•è¯•ä½¿ç”¨æ¨¡æ¿å¿«é€Ÿåˆ›å»ºå§ï¼
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = prizes.map(prize => `
                        <div class="prize-item" style="margin-bottom: 1rem;">
                            <div class="prize-header">
                                <div class="prize-name">${prize.name}</div>
                                <div class="prize-points">${prize.costPoints} ç§¯åˆ†</div>
                            </div>
                            
                            <div class="prize-description">${prize.description || 'æš‚æ— æè¿°'}</div>
                            
                            <div class="prize-meta">
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <span>åº“å­˜ï¼š${prize.stock}</span>
                                    <span style="color: ${prize.status === 'ACTIVE' ? '#28a745' : '#dc3545'};">
                                        ${prize.status === 'ACTIVE' ? 'å¯å…‘æ¢' : 'å·²ä¸‹æ¶'}
                                    </span>
                                    ${prize.expireDate ? `<span style="color: #666;">åˆ°æœŸï¼š${DateUtil.format(prize.expireDate, 'YYYY-MM-DD')}</span>` : ''}
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-warning" onclick="editPrize(${prize.id})">
                                        âœï¸ ç¼–è¾‘
                                    </button>
                                    <button class="btn btn-${prize.status === 'ACTIVE' ? 'danger' : 'success'}" 
                                            onclick="togglePrizeStatus(${prize.id}, '${prize.status}')">
                                        ${prize.status === 'ACTIVE' ? 'ğŸ“¤ ä¸‹æ¶' : 'ğŸ“¥ ä¸Šæ¶'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    throw new Error(response.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('prizesList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        <p>åŠ è½½å¥–å“å¤±è´¥</p>
                        <button class="btn btn-primary" onclick="loadPrizes()">é‡è¯•</button>
                    </div>
                `;
            } finally {
                Loading.hide();
            }
        }

        // åŠ è½½å…‘æ¢è®°å½•
        async function loadExchanges() {
            try {
                const container = document.getElementById('exchangesList');
                Loading.show(container);
                
                const response = await Http.get('/api/prizes/exchanges/pending');
                
                if (response.code === 200) {
                    const exchanges = response.data || [];
                    
                    if (exchanges.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>æš‚æ— å¾…ç¡®è®¤çš„å…‘æ¢è®°å½•</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = exchanges.map(exchange => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;">
                            <div>
                                <div style="font-weight: bold; color: #333;">${exchange.prizeName}</div>
                                <div style="color: #666; margin-top: 0.25rem;">æ¶ˆè€—ç§¯åˆ†: ${exchange.costPoints}</div>
                                <div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                                    å…‘æ¢æ—¶é—´ï¼š${formatDate(exchange.exchangedAt)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="task-status status-${exchange.status.toLowerCase()}" style="margin-bottom: 0.5rem;">
                                    ${getExchangeStatusText(exchange.status)}
                                </div>
                                ${exchange.status === 'PENDING' ? `
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-success btn-sm" onclick="confirmExchange(${exchange.id}, true)">
                                            âœ… ç¡®è®¤
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="confirmExchange(${exchange.id}, false)">
                                            âŒ æ‹’ç»
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    throw new Error(response.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('exchangesList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        <p>åŠ è½½å…‘æ¢è®°å½•å¤±è´¥</p>
                        <button class="btn btn-primary" onclick="loadExchanges()">é‡è¯•</button>
                    </div>
                `;
            } finally {
                Loading.hide();
            }
        }

        // ç¡®è®¤æˆ–æ‹’ç»å…‘æ¢
        async function confirmExchange(exchangeId, confirmed) {
            const action = confirmed ? 'ç¡®è®¤' : 'æ‹’ç»';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªå…‘æ¢ç”³è¯·å—ï¼Ÿ`)) {
                return;
            }

            try {
                Loading.show();
                const response = await Http.put(`/api/prizes/exchanges/${exchangeId}/confirm?confirmed=${confirmed}`);
                
                if (response.code === 200) {
                    Toast.success(`å…‘æ¢${action}æˆåŠŸï¼`);
                    loadExchanges(); // é‡æ–°åŠ è½½å…‘æ¢è®°å½•
                } else {
                    Toast.error(response.message || `${action}å¤±è´¥`);
                }
            } catch (error) {
                console.error('Confirm exchange error:', error);
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¶é—´';
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', error, dateString);
                return 'æ ¼å¼é”™è¯¯';
            }
        }

        // è·å–å…‘æ¢çŠ¶æ€æ–‡æœ¬
        function getExchangeStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…ç¡®è®¤',
                'CONFIRMED': 'å·²ç¡®è®¤',
                'CANCELLED': 'å·²æ‹’ç»'
            };
            return statusMap[status] || status;
        }

        // ç¼–è¾‘å¥–å“
        async function editPrize(prizeId) {
            try {
                // ä»å½“å‰åˆ—è¡¨ä¸­æ‰¾åˆ°å¥–å“æ•°æ®
                const response = await Http.get('/api/prizes/my-created');
                if (response.code !== 200) {
                    Toast.error('è·å–å¥–å“ä¿¡æ¯å¤±è´¥');
                    return;
                }

                const prize = response.data.find(p => p.id === prizeId);
                if (!prize) {
                    Toast.error('å¥–å“ä¸å­˜åœ¨');
                    return;
                }

                // å¡«å……ç¼–è¾‘è¡¨å•
                document.getElementById('editName').value = prize.name;
                document.getElementById('editDescription').value = prize.description || '';
                document.getElementById('editCostPoints').value = prize.costPoints;
                document.getElementById('editStock').value = prize.stock;

                currentEditPrizeId = prizeId;
                document.getElementById('editPrizeModal').style.display = 'block';
            } catch (error) {
                Toast.error('åŠ è½½å¥–å“ä¿¡æ¯å¤±è´¥');
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editPrizeModal').style.display = 'none';
            currentEditPrizeId = null;
        }

        // åˆ‡æ¢å¥–å“çŠ¶æ€
        async function togglePrizeStatus(prizeId, currentStatus) {
            const newStatus = currentStatus === 'ACTIVE' ? 'INACTIVE' : 'ACTIVE';
            const action = newStatus === 'ACTIVE' ? 'ä¸Šæ¶' : 'ä¸‹æ¶';

            try {
                Loading.show();
                const response = await Http.put(`/api/prizes/${prizeId}`, {
                    status: newStatus
                });

                if (response.code === 200) {
                    Toast.success(`å¥–å“${action}æˆåŠŸï¼`);
                    loadPrizes();
                } else {
                    Toast.error(response.message || `${action}å¤±è´¥`);
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('editPrizeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
</body>
</html> 