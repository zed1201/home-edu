<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿä¸­å¿ƒ - å®¶åº­æ•™è‚²ä»»åŠ¡ç§¯åˆ†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">ğŸ¯ å®¶åº­æ•™è‚²ç³»ç»Ÿ</div>
            <div class="nav-links">
                <a href="/student/dashboard.html" class="active">é¦–é¡µ</a>
                <a href="/student/available-tasks.html">å¯é¢†å–ä»»åŠ¡</a>
                <a href="/student/my-tasks.html">æˆ‘çš„ä»»åŠ¡</a>
                <a href="/student/exchange-prize.html">å¥–å“å…‘æ¢</a>
            </div>
            <div class="user-info">
                <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- æ¬¢è¿ä¿¡æ¯å’Œç§¯åˆ†å±•ç¤º -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h1>ğŸŒŸ æ¬¢è¿å›æ¥ï¼Œ<span id="studentName">åŒå­¦</span>ï¼</h1>
                    <p style="color: #666;">ç»§ç»­åŠªåŠ›å®Œæˆä»»åŠ¡ï¼Œèµšå–æ›´å¤šç§¯åˆ†å…‘æ¢å¿ƒä»ªçš„å¥–å“å§ï¼</p>
                </div>
                <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; min-width: 150px;">
                    <div style="font-size: 2rem; font-weight: bold;" id="currentPoints">-</div>
                    <div>å½“å‰ç§¯åˆ†</div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="dashboard">
            <div class="card stats-card">
                <div class="stats-number" id="totalTasks">-</div>
                <div class="stats-label">é¢†å–ä»»åŠ¡æ€»æ•°</div>
            </div>
            
            <div class="card stats-card">
                <div class="stats-number" id="completedTasks">-</div>
                <div class="stats-label">å·²å®Œæˆä»»åŠ¡</div>
            </div>
            
            <div class="card stats-card">
                <div class="stats-number" id="inProgressTasks">-</div>
                <div class="stats-label">è¿›è¡Œä¸­ä»»åŠ¡</div>
            </div>
            
            <div class="card stats-card">
                <div class="stats-number" id="earnedPoints">-</div>
                <div class="stats-label">ç´¯è®¡è·å¾—ç§¯åˆ†</div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="card">
            <h3>ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <a href="/student/available-tasks.html" class="btn btn-primary">
                    ğŸ“‹ é¢†å–æ–°ä»»åŠ¡
                </a>
                <a href="/student/my-tasks.html" class="btn btn-secondary">
                    ğŸ“ æŸ¥çœ‹æˆ‘çš„ä»»åŠ¡
                </a>
                <a href="/student/exchange-prize.html" class="btn btn-warning">
                    ğŸ å…‘æ¢å¥–å“
                </a>
                <button class="btn btn-success" onclick="viewPointsHistory()">
                    ğŸ“Š ç§¯åˆ†æ˜ç»†
                </button>
            </div>
        </div>

        <!-- ä»Šæ—¥ä»»åŠ¡ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>ğŸ“… ä»Šæ—¥ä»»åŠ¡</h3>
                <a href="/student/available-tasks.html" style="color: #667eea; text-decoration: none;">æŸ¥çœ‹æ›´å¤š â†’</a>
            </div>
            <div id="todayTasks" class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- è¿›è¡Œä¸­çš„ä»»åŠ¡ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>â³ è¿›è¡Œä¸­çš„ä»»åŠ¡</h3>
                <a href="/student/my-tasks.html" style="color: #667eea; text-decoration: none;">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
            </div>
            <div id="inProgressTasksList" class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- æœ€è¿‘ç§¯åˆ†åŠ¨æ€ -->
        <div class="card">
            <h3>ğŸ’ æœ€è¿‘ç§¯åˆ†åŠ¨æ€</h3>
            <div id="recentPointsHistory" class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- æ¨èå¥–å“ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>ğŸ æ¨èå¥–å“</h3>
                <a href="/student/exchange-prize.html" style="color: #667eea; text-decoration: none;">æŸ¥çœ‹æ›´å¤š â†’</a>
            </div>
            <div id="recommendedPrizes" class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- ç§¯åˆ†æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="pointsHistoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">
            <div class="card" style="max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>ğŸ“Š ç§¯åˆ†æ˜ç»†</h3>
                    <button class="btn btn-secondary" onclick="closePointsHistory()">âœ•</button>
                </div>
                <div id="pointsHistoryContent">
                    <!-- ç§¯åˆ†æ˜ç»†å†…å®¹å°†é€šè¿‡JSå¡«å…… -->
                </div>
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            if (!Page.requireAuth() || !Page.requireRole('STUDENT')) {
                return;
            }

            const user = Storage.getUser();
            document.getElementById('studentName').textContent = user.realName || user.username;

            // åŠ è½½æ•°æ®
            loadDashboardData();
        });

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadCurrentPoints(),
                    loadStatistics(),
                    loadTodayTasks(),
                    loadInProgressTasks(),
                    loadRecentPointsHistory(),
                    loadRecommendedPrizes()
                ]);
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                Toast.error('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // åŠ è½½å½“å‰ç§¯åˆ†
        async function loadCurrentPoints() {
            try {
                const response = await Http.get('/api/points/current');
                if (response.code === 200) {
                    document.getElementById('currentPoints').textContent = response.data || 0;
                }
            } catch (error) {
                document.getElementById('currentPoints').textContent = '0';
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStatistics() {
            try {
                const [myTasks, pointsResponse] = await Promise.all([
                    Http.get('/api/tasks/my-assigned'),
                    Http.get('/api/points/logs')
                ]);

                if (myTasks.code === 200) {
                    const tasks = myTasks.data || [];
                    document.getElementById('totalTasks').textContent = tasks.length;
                    document.getElementById('completedTasks').textContent = 
                        tasks.filter(task => task.status === 'DONE').length;
                    document.getElementById('inProgressTasks').textContent = 
                        tasks.filter(task => task.status === 'IN_PROGRESS' || task.status === 'WAIT_CONFIRM').length;
                }

                if (pointsResponse.code === 200) {
                    const pointsLogs = pointsResponse.data || [];
                    const earnedPoints = pointsLogs
                        .filter(log => log.type === 'EARN')
                        .reduce((sum, log) => sum + log.points, 0);
                    document.getElementById('earnedPoints').textContent = earnedPoints;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä»Šæ—¥ä»»åŠ¡
        async function loadTodayTasks() {
            try {
                const response = await Http.get('/api/tasks/available');
                const container = document.getElementById('todayTasks');
                
                if (response.code === 200 && response.data && response.data.length > 0) {
                    // åªæ˜¾ç¤ºå‰3ä¸ªå¯é¢†å–çš„ä»»åŠ¡
                    const todayTasks = response.data.slice(0, 3);

                    container.innerHTML = todayTasks.map(task => `
                        <div class="task-item" style="margin-bottom: 1rem;">
                            <div class="task-header">
                                <div class="task-title">${task.title}</div>
                                <div class="task-points">${task.point} ç§¯åˆ†</div>
                            </div>
                            <div class="task-description">${task.description || 'æš‚æ— æè¿°'}</div>
                            <div class="task-meta">
                                <span class="task-deadline">æˆªæ­¢ï¼š${DateUtil.format(task.deadline)}</span>
                                <button class="btn btn-primary" onclick="assignTask(${task.id})">
                                    âœ… é¢†å–ä»»åŠ¡
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            ä»Šæ—¥æš‚æ— æ–°ä»»åŠ¡ï¼Œ<a href="/student/available-tasks.html" style="color: #667eea;">æŸ¥çœ‹æ‰€æœ‰å¯é¢†å–ä»»åŠ¡</a>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('todayTasks').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        åŠ è½½ä»Šæ—¥ä»»åŠ¡å¤±è´¥
                    </div>
                `;
            }
        }

        // åŠ è½½è¿›è¡Œä¸­çš„ä»»åŠ¡
        async function loadInProgressTasks() {
            try {
                const response = await Http.get('/api/tasks/my-assigned');
                const container = document.getElementById('inProgressTasksList');
                
                if (response.code === 200 && response.data && response.data.length > 0) {
                    const inProgressTasks = response.data.filter(task => 
                        task.status === 'IN_PROGRESS' || task.status === 'WAIT_CONFIRM'
                    ).slice(0, 3); // åªæ˜¾ç¤ºå‰3ä¸ª

                    if (inProgressTasks.length > 0) {
                        container.innerHTML = inProgressTasks.map(task => `
                            <div class="task-item" style="margin-bottom: 1rem;">
                                <div class="task-header">
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-status status-${task.status.toLowerCase().replace('_', '-')}">${getStatusText(task.status)}</div>
                                </div>
                                <div class="task-description">${task.description || 'æš‚æ— æè¿°'}</div>
                                <div class="task-meta">
                                    <span class="task-deadline">æˆªæ­¢ï¼š${DateUtil.format(task.deadline)}</span>
                                    <div style="display: flex; gap: 0.5rem;">
                                        ${task.status === 'IN_PROGRESS' ? `
                                            <button class="btn btn-success" onclick="submitTask(${task.id})">
                                                ğŸ“¤ æäº¤å®Œæˆ
                                            </button>
                                        ` : ''}
                                        <a href="/student/my-tasks.html" class="btn btn-secondary">
                                            ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œ<a href="/student/available-tasks.html" style="color: #667eea;">å»é¢†å–æ–°ä»»åŠ¡</a>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œ<a href="/student/available-tasks.html" style="color: #667eea;">å»é¢†å–æ–°ä»»åŠ¡</a>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('inProgressTasksList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        åŠ è½½è¿›è¡Œä¸­ä»»åŠ¡å¤±è´¥
                    </div>
                `;
            }
        }

        // åŠ è½½æœ€è¿‘ç§¯åˆ†åŠ¨æ€
        async function loadRecentPointsHistory() {
            try {
                const response = await Http.get('/api/points/logs');
                const container = document.getElementById('recentPointsHistory');
                
                if (response.code === 200 && response.data && response.data.length > 0) {
                    // æŒ‰æ—¶é—´æ’åºï¼Œå–æœ€è¿‘5æ¡
                    const recentLogs = response.data
                        .sort((a, b) => new Date(b.createTime) - new Date(a.createTime))
                        .slice(0, 5);

                    container.innerHTML = recentLogs.map(log => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;">
                            <div>
                                <div style="font-weight: bold; color: ${log.points > 0 ? '#28a745' : '#dc3545'};">
                                    ${log.points > 0 ? '+' : ''}${log.points} ç§¯åˆ†
                                </div>
                                <div style="font-size: 0.9rem; color: #666;">${log.description}</div>
                            </div>
                            <div style="font-size: 0.8rem; color: #999;">
                                ${DateUtil.format(log.createdAt)}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            æš‚æ— ç§¯åˆ†è®°å½•
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('recentPointsHistory').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        åŠ è½½ç§¯åˆ†åŠ¨æ€å¤±è´¥
                    </div>
                `;
            }
        }

        // åŠ è½½æ¨èå¥–å“
        async function loadRecommendedPrizes() {
            try {
                const response = await Http.get('/api/prizes/available');
                const container = document.getElementById('recommendedPrizes');
                
                console.log('æ¨èå¥–å“APIå“åº”:', response); // è°ƒè¯•æ—¥å¿—
                
                if (response.code === 200 && response.data && response.data.length > 0) {
                    // åªæ˜¾ç¤ºå‰3ä¸ªå¥–å“
                    const recommendedPrizes = response.data.slice(0, 3);

                    console.log('æ¨èå¥–å“æ•°æ®:', recommendedPrizes); // è°ƒè¯•æ—¥å¿—

                    container.innerHTML = recommendedPrizes.map(prize => {
                        try {
                            return `
                                <div class="prize-item" style="margin-bottom: 1rem;">
                                    <div class="prize-header">
                                        <div class="prize-name">${prize.name || ''}</div>
                                        <div class="prize-points">${prize.costPoints || 0} ç§¯åˆ†</div>
                                    </div>
                                    <div class="prize-description">${prize.description || 'æš‚æ— æè¿°'}</div>
                                    <div class="prize-meta">
                                        <span>åº“å­˜ï¼š${prize.stock || 0}</span>
                                        <button class="btn btn-warning" onclick="exchangePrize(${prize.id})">
                                            ğŸ ç«‹å³å…‘æ¢
                                        </button>
                                    </div>
                                </div>
                            `;
                        } catch (prizeError) {
                            console.error('æ¸²æŸ“å•ä¸ªå¥–å“å¤±è´¥:', prizeError, prize);
                            return `
                                <div class="prize-item" style="margin-bottom: 1rem;">
                                    <div style="color: #dc3545; padding: 1rem;">
                                        å¥–å“æ˜¾ç¤ºå‡ºé”™: ${prize.name || 'æœªçŸ¥'}
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                } else {
                    console.log('æ— å¥–å“æ•°æ®æˆ–æ•°æ®ä¸ºç©º'); // è°ƒè¯•æ—¥å¿—
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            æš‚æ— å¯å…‘æ¢å¥–å“
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ¨èå¥–å“å¤±è´¥:', error); // è°ƒè¯•æ—¥å¿—
                document.getElementById('recommendedPrizes').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        åŠ è½½æ¨èå¥–å“å¤±è´¥ï¼š${error.message}
                    </div>
                `;
            }
        }

        // é¢†å–ä»»åŠ¡
        async function assignTask(taskId) {
            try {
                Loading.show();
                const response = await Http.post(`/api/tasks/${taskId}/assign`);
                
                if (response.code === 200) {
                    Toast.success('ä»»åŠ¡é¢†å–æˆåŠŸï¼');
                    // é‡æ–°åŠ è½½ç›¸å…³æ•°æ®
                    loadTodayTasks();
                    loadStatistics();
                } else {
                    Toast.error(response.message || 'é¢†å–å¤±è´¥');
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // æäº¤ä»»åŠ¡
        async function submitTask(taskId) {
            const submitContent = prompt('è¯·è¾“å…¥ä»»åŠ¡å®Œæˆè¯´æ˜ï¼ˆå¯é€‰ï¼‰ï¼š');
            if (submitContent === null) return; // ç”¨æˆ·å–æ¶ˆ

            try {
                Loading.show();
                const response = await Http.post(`/api/tasks/${taskId}/submit`, {
                    submitContent: submitContent || 'ä»»åŠ¡å·²å®Œæˆ'
                });
                
                if (response.code === 200) {
                    Toast.success('ä»»åŠ¡æäº¤æˆåŠŸï¼Œç­‰å¾…å®¶é•¿ç¡®è®¤ï¼');
                    // é‡æ–°åŠ è½½ç›¸å…³æ•°æ®
                    loadInProgressTasks();
                    loadStatistics();
                } else {
                    Toast.error(response.message || 'æäº¤å¤±è´¥');
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // å…‘æ¢å¥–å“
        async function exchangePrize(prizeId) {
            try {
                Loading.show();
                const response = await Http.post(`/api/prizes/${prizeId}/exchange`);
                
                if (response.code === 200) {
                    Toast.success('å¥–å“å…‘æ¢æˆåŠŸï¼');
                    // é‡æ–°åŠ è½½ç›¸å…³æ•°æ®
                    loadCurrentPoints();
                    loadRecommendedPrizes();
                } else {
                    Toast.error(response.message || 'å…‘æ¢å¤±è´¥');
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // æŸ¥çœ‹ç§¯åˆ†å†å²
        async function viewPointsHistory() {
            try {
                Loading.show();
                const response = await Http.get('/api/points/logs');
                
                if (response.code === 200) {
                    const pointsLogs = response.data || [];
                    const content = document.getElementById('pointsHistoryContent');
                    
                    if (pointsLogs.length === 0) {
                        content.innerHTML = `
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                æš‚æ— ç§¯åˆ†è®°å½•
                            </div>
                        `;
                    } else {
                        content.innerHTML = pointsLogs.map(log => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #eee;">
                                <div>
                                    <div style="font-weight: bold; color: ${log.points > 0 ? '#28a745' : '#dc3545'};">
                                        ${log.points > 0 ? '+' : ''}${log.points} ç§¯åˆ†
                                    </div>
                                    <div style="color: #666; margin-top: 0.25rem;">${log.description}</div>
                                    <div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                                        ${getTypeText(log.type)}
                                    </div>
                                </div>
                                <div style="text-align: right; font-size: 0.9rem; color: #666;">
                                    ${DateUtil.format(log.createdAt)}
                                </div>
                            </div>
                        `).join('');
                    }

                    document.getElementById('pointsHistoryModal').style.display = 'block';
                } else {
                    Toast.error('åŠ è½½ç§¯åˆ†æ˜ç»†å¤±è´¥');
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // å…³é—­ç§¯åˆ†å†å²æ¨¡æ€æ¡†
        function closePointsHistory() {
            document.getElementById('pointsHistoryModal').style.display = 'none';
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'PUBLISHED': 'å·²å‘å¸ƒ',
                'IN_PROGRESS': 'è¿›è¡Œä¸­',
                'WAIT_CONFIRM': 'å¾…ç¡®è®¤',
                'DONE': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        // è·å–ç§¯åˆ†ç±»å‹æ–‡æœ¬
        function getTypeText(type) {
            const typeMap = {
                'TASK': 'ä»»åŠ¡å¥–åŠ±',
                'PRIZE': 'å¥–å“å…‘æ¢',
                'ADJUST': 'ç³»ç»Ÿè°ƒæ•´'
            };
            return typeMap[type] || type;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('pointsHistoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePointsHistory();
            }
        });
    </script>
</body>
</html> 