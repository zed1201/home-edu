<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶é•¿ä¸­å¿ƒ - å®¶åº­æ•™è‚²ä»»åŠ¡ç§¯åˆ†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">ğŸ¯ å®¶åº­æ•™è‚²ç³»ç»Ÿ</div>
            <div class="nav-links">
                <a href="/parent/dashboard.html" class="active">é¦–é¡µ</a>
                <a href="/parent/create-task.html">å‘å¸ƒä»»åŠ¡</a>
                <a href="/parent/task-list.html">ä»»åŠ¡ç®¡ç†</a>
                <a href="/parent/create-prize.html">å¥–å“ç®¡ç†</a>
            </div>
            <div class="user-info">
                <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- æ¬¢è¿ä¿¡æ¯ -->
        <div class="card">
            <h1>ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ<span id="parentName">å®¶é•¿</span>ï¼</h1>
            <p>é€šè¿‡ä»»åŠ¡ç§¯åˆ†ç³»ç»Ÿï¼Œå¸®åŠ©å­©å­å…»æˆè‰¯å¥½ä¹ æƒ¯ï¼Œæ¿€å‘å­¦ä¹ åŠ¨åŠ›ã€‚</p>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="dashboard">
            <div class="card stats-card">
                <div class="stats-number" id="totalTasks">-</div>
                <div class="stats-label">å‘å¸ƒä»»åŠ¡æ€»æ•°</div>
            </div>
            
            <div class="card stats-card">
                <div class="stats-number" id="pendingTasks">-</div>
                <div class="stats-label">å¾…ç¡®è®¤ä»»åŠ¡</div>
            </div>
            
            <div class="card stats-card">
                <div class="stats-number" id="completedTasks">-</div>
                <div class="stats-label">å·²å®Œæˆä»»åŠ¡</div>
            </div>
            
            <div class="card stats-card">
                <div class="stats-number" id="totalPrizes">-</div>
                <div class="stats-label">å¥–å“æ€»æ•°</div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="card">
            <h3>ğŸ“‹ å¿«é€Ÿæ“ä½œ</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <a href="/parent/create-task.html" class="btn btn-primary">
                    â• å‘å¸ƒæ–°ä»»åŠ¡
                </a>
                <a href="/parent/task-list.html" class="btn btn-secondary">
                    ğŸ“ ç®¡ç†ä»»åŠ¡
                </a>
                <a href="/parent/create-prize.html" class="btn btn-warning">
                    ğŸ åˆ›å»ºå¥–å“
                </a>
                <button class="btn btn-success" onclick="loadStudentStats()">
                    ğŸ“Š æŸ¥çœ‹å­¦ç”Ÿç§¯åˆ†
                </button>
            </div>
        </div>

        <!-- å­¦ç”Ÿç§¯åˆ†æ¦‚è§ˆ -->
        <div class="card">
            <h3>ğŸ‘¥ æˆ‘çš„å­¦ç”Ÿç§¯åˆ†æ¦‚è§ˆ</h3>
            <div id="studentsList" class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- æœ€è¿‘ä»»åŠ¡ -->
        <div class="card">
            <h3>ğŸ• æœ€è¿‘ä»»åŠ¡åŠ¨æ€</h3>
            <div id="recentTasks" class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- å¾…ç¡®è®¤ä»»åŠ¡ -->
        <div class="card">
            <h3>â° å¾…ç¡®è®¤ä»»åŠ¡</h3>
            <div id="pendingTasksList" class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            if (!Page.requireAuth() || !Page.requireRole('PARENT')) {
                return;
            }

            const user = Storage.getUser();
            document.getElementById('parentName').textContent = user.realName || user.username;

            // åŠ è½½æ•°æ®
            loadDashboardData();
        });

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadStatistics(),
                    loadStudentsList(),
                    loadRecentTasks(),
                    loadPendingTasks()
                ]);
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                Toast.error('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStatistics() {
            try {
                const [myTasks, pendingResponse] = await Promise.all([
                    Http.get('/api/tasks/my-created'),
                    Http.get('/api/tasks/pending-confirm')
                ]);

                if (myTasks.code === 200) {
                    const tasks = myTasks.data || [];
                    document.getElementById('totalTasks').textContent = tasks.length;
                    document.getElementById('completedTasks').textContent = 
                        tasks.filter(task => task.status === 'DONE').length;
                }

                if (pendingResponse.code === 200) {
                    document.getElementById('pendingTasks').textContent = 
                        (pendingResponse.data || []).length;
                }

                // åŠ è½½å¥–å“ç»Ÿè®¡
                const prizesResponse = await Http.get('/api/prizes/my-created');
                if (prizesResponse.code === 200) {
                    document.getElementById('totalPrizes').textContent = 
                        (prizesResponse.data || []).length;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
        async function loadStudentsList() {
            try {
                const user = Storage.getUser();
                const response = await Http.get(`/api/user/${user.userId}/students`);
                
                const container = document.getElementById('studentsList');
                
                if (response.code === 200 && response.data && response.data.length > 0) {
                    const students = response.data;
                    
                    // è·å–æ¯ä¸ªå­¦ç”Ÿçš„ç§¯åˆ†
                    const studentsWithPoints = await Promise.all(
                        students.map(async (student) => {
                            try {
                                const pointsResponse = await Http.get('/api/points/current', {
                                    headers: { 'User-Id': student.id }
                                });
                                return {
                                    ...student,
                                    points: pointsResponse.code === 200 ? pointsResponse.data : 0
                                };
                            } catch (error) {
                                return { ...student, points: 0 };
                            }
                        })
                    );

                    container.innerHTML = studentsWithPoints.map(student => `
                        <div class="task-item" style="margin-bottom: 1rem;">
                            <div class="task-header">
                                <div class="task-title">${student.realName || student.username}</div>
                                <div class="task-points">${student.points} ç§¯åˆ†</div>
                            </div>
                            <div style="color: #666;">
                                ç”¨æˆ·åï¼š${student.username}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <p>è¿˜æ²¡æœ‰ç»‘å®šå­¦ç”Ÿ</p>
                            <p style="margin-top: 1rem; font-size: 0.9rem;">
                                è¯·è®©å­¦ç”Ÿæ³¨å†Œè´¦å·åï¼Œä½¿ç”¨ç»‘å®šåŠŸèƒ½å»ºç«‹å…³ç³»
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('studentsList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        åŠ è½½å­¦ç”Ÿä¿¡æ¯å¤±è´¥
                    </div>
                `;
            }
        }

        // åŠ è½½æœ€è¿‘ä»»åŠ¡
        async function loadRecentTasks() {
            try {
                const response = await Http.get('/api/tasks/my-created');
                const container = document.getElementById('recentTasks');
                
                if (response.code === 200 && response.data && response.data.length > 0) {
                    // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œå–æœ€è¿‘5ä¸ª
                    const recentTasks = response.data
                        .sort((a, b) => new Date(b.createTime) - new Date(a.createTime))
                        .slice(0, 5);

                    container.innerHTML = recentTasks.map(task => `
                        <div class="task-item" style="margin-bottom: 1rem;">
                            <div class="task-header">
                                <div class="task-title">${task.title}</div>
                                <div class="task-status status-${task.status.toLowerCase().replace('_', '-')}">${getStatusText(task.status)}</div>
                            </div>
                            <div class="task-description">${task.description}</div>
                            <div class="task-meta">
                                <span class="task-deadline">æˆªæ­¢ï¼š${DateUtil.format(task.deadline)}</span>
                                <span class="task-points">${task.point} ç§¯åˆ†</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            è¿˜æ²¡æœ‰å‘å¸ƒä»»åŠ¡ï¼Œ<a href="/parent/create-task.html" style="color: #667eea;">ç‚¹å‡»å‘å¸ƒç¬¬ä¸€ä¸ªä»»åŠ¡</a>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('recentTasks').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        åŠ è½½ä»»åŠ¡å¤±è´¥
                    </div>
                `;
            }
        }

        // åŠ è½½å¾…ç¡®è®¤ä»»åŠ¡
        async function loadPendingTasks() {
            try {
                const response = await Http.get('/api/tasks/pending-confirm');
                const container = document.getElementById('pendingTasksList');
                
                if (response.code === 200 && response.data && response.data.length > 0) {
                    container.innerHTML = response.data.map(task => `
                        <div class="task-item" style="margin-bottom: 1rem;">
                            <div class="task-header">
                                <div class="task-title">${task.title}</div>
                                <div class="task-points">${task.point} ç§¯åˆ†</div>
                            </div>
                            <div class="task-description">${task.description}</div>
                            <div class="task-meta">
                                <span>æäº¤æ—¶é—´ï¼š${DateUtil.format(task.submitTime)}</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-success" onclick="confirmTask(${task.id}, true)">
                                        âœ… ç¡®è®¤å®Œæˆ
                                    </button>
                                    <button class="btn btn-danger" onclick="confirmTask(${task.id}, false)">
                                        âŒ é‡æ–°å®Œæˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            æš‚æ— å¾…ç¡®è®¤çš„ä»»åŠ¡
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('pendingTasksList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        åŠ è½½å¾…ç¡®è®¤ä»»åŠ¡å¤±è´¥
                    </div>
                `;
            }
        }

        // ç¡®è®¤ä»»åŠ¡
        async function confirmTask(taskId, isCompleted) {
            try {
                Loading.show();
                const response = await Http.put(`/api/tasks/${taskId}/confirm`, {
                    isCompleted: isCompleted,
                    finalPoint: null // ä½¿ç”¨åŸå§‹ç§¯åˆ†
                });

                if (response.code === 200) {
                    Toast.success(isCompleted ? 'ä»»åŠ¡ç¡®è®¤å®Œæˆï¼' : 'ä»»åŠ¡å·²è¦æ±‚é‡æ–°å®Œæˆ');
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadDashboardData();
                } else {
                    Toast.error(response.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'PUBLISHED': 'å·²å‘å¸ƒ',
                'IN_PROGRESS': 'è¿›è¡Œä¸­',
                'WAIT_CONFIRM': 'å¾…ç¡®è®¤',
                'DONE': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        // åŠ è½½å­¦ç”Ÿç§¯åˆ†ç»Ÿè®¡
        function loadStudentStats() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„å­¦ç”Ÿç§¯åˆ†ç»Ÿè®¡é¡µé¢
            Toast.info('åŠŸèƒ½å¼€å‘ä¸­...');
        }
    </script>
</body>
</html> 