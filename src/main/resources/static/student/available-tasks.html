<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯é¢†å–ä»»åŠ¡ - å®¶åº­æ•™è‚²ä»»åŠ¡ç§¯åˆ†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">ğŸ¯ å®¶åº­æ•™è‚²ç³»ç»Ÿ</div>
            <div class="nav-links">
                <a href="/student/dashboard.html">é¦–é¡µ</a>
                <a href="/student/available-tasks.html" class="active">å¯é¢†å–ä»»åŠ¡</a>
                <a href="/student/my-tasks.html">æˆ‘çš„ä»»åŠ¡</a>
                <a href="/student/exchange-prize.html">å¥–å“å…‘æ¢</a>
            </div>
            <div class="user-info">
                <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜å’Œç§¯åˆ†æ˜¾ç¤º -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h2>ğŸ“‹ å¯é¢†å–ä»»åŠ¡</h2>
                    <p style="color: #666; margin: 0;">é€‰æ‹©æ„Ÿå…´è¶£çš„ä»»åŠ¡å¼€å§‹æŒ‘æˆ˜å§ï¼</p>
                </div>
                <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; min-width: 120px;">
                    <div style="font-size: 1.5rem; font-weight: bold;" id="currentPoints">-</div>
                    <div style="font-size: 0.9rem;">å½“å‰ç§¯åˆ†</div>
                </div>
            </div>
            
            <!-- ç­›é€‰å’Œæœç´¢ -->
            <div class="filter-bar">
                <div class="filter-item">
                    <label for="pointsFilter">ç§¯åˆ†ç­›é€‰ï¼š</label>
                    <select id="pointsFilter" onchange="filterTasks()">
                        <option value="">å…¨éƒ¨ç§¯åˆ†</option>
                        <option value="5">5åˆ†ä»¥ä¸‹</option>
                        <option value="10">5-10åˆ†</option>
                        <option value="20">10-20åˆ†</option>
                        <option value="50">20åˆ†ä»¥ä¸Š</option>
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="searchInput">æœç´¢ï¼š</label>
                    <input type="text" id="searchInput" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜..." 
                           onkeyup="searchTasks()">
                </div>
                
                <button class="btn btn-secondary btn-sm" onclick="loadTasks()">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- ä»»åŠ¡ç»Ÿè®¡ -->
        <div class="grid-4" style="margin-bottom: 2rem;">
            <div class="card stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <div class="stats-number" id="availableTasksCount">-</div>
                <div class="stats-label">å¯é¢†å–ä»»åŠ¡</div>
            </div>
            <div class="card stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);">
                <div class="stats-number" id="avgPoints">-</div>
                <div class="stats-label">å¹³å‡ç§¯åˆ†</div>
            </div>
            <div class="card stats-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
                <div class="stats-number" id="urgentTasks">-</div>
                <div class="stats-label">ç´§æ€¥ä»»åŠ¡</div>
            </div>
            <div class="card stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
                <div class="stats-number" id="highRewardTasks">-</div>
                <div class="stats-label">é«˜åˆ†ä»»åŠ¡</div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="card">
            <h3>ğŸ“ ä»»åŠ¡åˆ—è¡¨</h3>
            <div id="tasksList" class="task-list loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="taskDetailModal" class="modal" style="display: none;">
        <div class="modal-content card" style="max-width: 600px; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>ğŸ“‹ ä»»åŠ¡è¯¦æƒ…</h3>
                <button class="btn btn-secondary btn-sm" onclick="closeTaskDetail()">âœ•</button>
            </div>
            <div id="taskDetailContent">
                <!-- ä»»åŠ¡è¯¦æƒ…å†…å®¹å°†é€šè¿‡JSå¡«å…… -->
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        let allTasks = [];
        let filteredTasks = [];

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            if (!Page.requireAuth() || !Page.requireRole('STUDENT')) {
                return;
            }

            loadCurrentPoints();
            loadTasks();
        });

        // åŠ è½½å½“å‰ç§¯åˆ†
        async function loadCurrentPoints() {
            try {
                const response = await Http.get('/api/points/current');
                if (response.code === 200) {
                    document.getElementById('currentPoints').textContent = response.data || 0;
                }
            } catch (error) {
                document.getElementById('currentPoints').textContent = '0';
            }
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                Loading.show(document.getElementById('tasksList'));
                const response = await Http.get('/api/tasks/available');
                
                if (response.code === 200) {
                    allTasks = response.data || [];
                    filteredTasks = [...allTasks];
                    
                    updateStatistics();
                    renderTasks();
                } else {
                    throw new Error(response.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('tasksList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                        <p>åŠ è½½ä»»åŠ¡å¤±è´¥</p>
                        <button class="btn btn-primary" onclick="loadTasks()">é‡è¯•</button>
                    </div>
                `;
                Toast.error('åŠ è½½ä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            
            const stats = {
                available: allTasks.length,
                avgPoints: allTasks.length > 0 ? Math.round(allTasks.reduce((sum, task) => sum + task.point, 0) / allTasks.length) : 0,
                urgent: allTasks.filter(task => new Date(task.deadline) <= tomorrow).length,
                highReward: allTasks.filter(task => task.point >= 20).length
            };

            document.getElementById('availableTasksCount').textContent = stats.available;
            document.getElementById('avgPoints').textContent = stats.avgPoints;
            document.getElementById('urgentTasks').textContent = stats.urgent;
            document.getElementById('highRewardTasks').textContent = stats.highReward;
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const container = document.getElementById('tasksList');
            
            if (filteredTasks.length === 0) {
                if (allTasks.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <p>æš‚æ— å¯é¢†å–çš„ä»»åŠ¡</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">è¯·è”ç³»å®¶é•¿å‘å¸ƒæ–°ä»»åŠ¡</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡</p>
                            <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰æ¡ä»¶</button>
                        </div>
                    `;
                }
                return;
            }

            // æŒ‰æˆªæ­¢æ—¶é—´æ’åºï¼Œç´§æ€¥çš„åœ¨å‰é¢
            const sortedTasks = filteredTasks.sort((a, b) => {
                // é¦–å…ˆæŒ‰æ˜¯å¦ç´§æ€¥æ’åº
                const aUrgent = isUrgentTask(a);
                const bUrgent = isUrgentTask(b);
                if (aUrgent !== bUrgent) {
                    return bUrgent - aUrgent; // ç´§æ€¥çš„æ’åœ¨å‰é¢
                }
                // ç„¶åæŒ‰ç§¯åˆ†æ’åºï¼ˆé«˜ç§¯åˆ†åœ¨å‰ï¼‰
                return b.point - a.point;
            });

            container.innerHTML = sortedTasks.map(task => {
                const isUrgent = isUrgentTask(task);
                const timeLeft = DateUtil.fromNow(task.deadline);
                
                return `
                    <div class="task-item" style="margin-bottom: 1rem; ${isUrgent ? 'border-left: 4px solid #dc3545;' : ''}">
                        <div class="task-header">
                            <div class="task-title">
                                ${task.title}
                                ${isUrgent ? '<span style="color: #dc3545; font-size: 0.8rem; margin-left: 0.5rem;">ğŸ”¥ ç´§æ€¥</span>' : ''}
                            </div>
                            <div class="task-points">${task.point} ç§¯åˆ†</div>
                        </div>
                        
                        <div class="task-description">${task.description || 'æš‚æ— æè¿°'}</div>
                        
                        <div class="task-meta">
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <span class="task-deadline" style="color: ${isUrgent ? '#dc3545' : '#666'};">
                                    æˆªæ­¢ï¼š${DateUtil.format(task.deadline)} (${timeLeft})
                                </span>
                                <span style="color: #666; font-size: 0.9rem;">
                                    å‘å¸ƒï¼š${DateUtil.format(task.createTime)}
                                </span>
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="viewTaskDetail(${task.id})">
                                    ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
                                </button>
                                <button class="btn btn-primary" onclick="assignTask(${task.id})">
                                    âœ… é¢†å–ä»»åŠ¡
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯ç´§æ€¥ä»»åŠ¡ï¼ˆ24å°æ—¶å†…æˆªæ­¢ï¼‰
        function isUrgentTask(task) {
            const now = new Date();
            const deadline = new Date(task.deadline);
            const timeDiff = deadline.getTime() - now.getTime();
            return timeDiff <= 24 * 60 * 60 * 1000 && timeDiff > 0; // 24å°æ—¶å†…ä¸”æœªè¿‡æœŸ
        }

        // ç­›é€‰ä»»åŠ¡
        function filterTasks() {
            const pointsFilter = document.getElementById('pointsFilter').value;
            const searchKeyword = document.getElementById('searchInput').value.toLowerCase();

            filteredTasks = allTasks.filter(task => {
                // ç§¯åˆ†ç­›é€‰
                let matchPoints = true;
                if (pointsFilter) {
                    const filterValue = parseInt(pointsFilter);
                    if (filterValue === 5) {
                        matchPoints = task.point < 5;
                    } else if (filterValue === 10) {
                        matchPoints = task.point >= 5 && task.point <= 10;
                    } else if (filterValue === 20) {
                        matchPoints = task.point > 10 && task.point <= 20;
                    } else if (filterValue === 50) {
                        matchPoints = task.point > 20;
                    }
                }

                // å…³é”®è¯æœç´¢
                const matchSearch = !searchKeyword || 
                    task.title.toLowerCase().includes(searchKeyword) ||
                    (task.description && task.description.toLowerCase().includes(searchKeyword));
                
                return matchPoints && matchSearch;
            });

            renderTasks();
        }

        // æœç´¢ä»»åŠ¡
        function searchTasks() {
            filterTasks();
        }

        // æ¸…é™¤ç­›é€‰æ¡ä»¶
        function clearFilters() {
            document.getElementById('pointsFilter').value = '';
            document.getElementById('searchInput').value = '';
            filteredTasks = [...allTasks];
            renderTasks();
        }

        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        async function viewTaskDetail(taskId) {
            try {
                const task = allTasks.find(t => t.id === taskId);
                if (!task) {
                    Toast.error('ä»»åŠ¡ä¸å­˜åœ¨');
                    return;
                }

                const content = document.getElementById('taskDetailContent');
                const isUrgent = isUrgentTask(task);
                const timeLeft = DateUtil.fromNow(task.deadline);

                content.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <h4>${task.title}</h4>
                        ${isUrgent ? '<div style="color: #dc3545; font-weight: bold; margin-bottom: 0.5rem;">ğŸ”¥ ç´§æ€¥ä»»åŠ¡</div>' : ''}
                        <div class="task-points" style="display: inline-block;">${task.point} ç§¯åˆ†</div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>ä»»åŠ¡æè¿°ï¼š</strong>
                        <p style="margin: 0.5rem 0; line-height: 1.6; background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                            ${task.description || 'æš‚æ— è¯¦ç»†æè¿°'}
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong>å¥–åŠ±ç§¯åˆ†ï¼š</strong>
                            <span class="task-points">${task.point} ç§¯åˆ†</span>
                        </div>
                        <div>
                            <strong>æˆªæ­¢æ—¶é—´ï¼š</strong>
                            <span style="color: ${isUrgent ? '#dc3545' : 'inherit'};">
                                ${DateUtil.format(task.deadline)}
                            </span>
                        </div>
                        <div>
                            <strong>å‰©ä½™æ—¶é—´ï¼š</strong>
                            <span style="color: ${isUrgent ? '#dc3545' : '#666'};">${timeLeft}</span>
                        </div>
                        <div>
                            <strong>å‘å¸ƒæ—¶é—´ï¼š</strong>
                            <span>${DateUtil.format(task.createTime)}</span>
                        </div>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                        <strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong>
                        <ul style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                            <li>é¢†å–ä»»åŠ¡åè¯·æŒ‰æ—¶å®Œæˆ</li>
                            <li>å®ŒæˆååŠæ—¶æäº¤ç­‰å¾…å®¶é•¿ç¡®è®¤</li>
                            <li>ç¡®è®¤å®Œæˆåç§¯åˆ†ä¼šè‡ªåŠ¨æ·»åŠ åˆ°è´¦æˆ·</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="assignTaskFromDetail(${task.id})" style="flex: 1;">
                            âœ… ç«‹å³é¢†å–
                        </button>
                        <button class="btn btn-secondary" onclick="closeTaskDetail()">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                `;

                document.getElementById('taskDetailModal').style.display = 'block';
            } catch (error) {
                Toast.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥');
            }
        }

        // å…³é—­ä»»åŠ¡è¯¦æƒ…
        function closeTaskDetail() {
            document.getElementById('taskDetailModal').style.display = 'none';
        }

        // ä»è¯¦æƒ…é¡µé¢é¢†å–ä»»åŠ¡
        async function assignTaskFromDetail(taskId) {
            await assignTask(taskId);
            closeTaskDetail();
        }

        // é¢†å–ä»»åŠ¡
        async function assignTask(taskId) {
            try {
                Loading.show();
                const response = await Http.post(`/api/tasks/${taskId}/assign`);
                
                if (response.code === 200) {
                    Toast.success('ä»»åŠ¡é¢†å–æˆåŠŸï¼å»"æˆ‘çš„ä»»åŠ¡"æŸ¥çœ‹å§');
                    // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    await loadTasks();
                } else {
                    Toast.error(response.message || 'é¢†å–å¤±è´¥');
                }
            } catch (error) {
                Toast.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                Loading.hide();
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('taskDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskDetail();
            }
        });
    </script>
</body>
</html> 